{% extends "base.html" %}

{% block title %}Investigação #{{ investigacao.id }} - Sistema PIP{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="bi bi-file-earmark-text"></i> Investigação #{{ investigacao.id }}
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{{ url_for('editar_investigacao', id=investigacao.id) }}" class="btn btn-sm btn-warning me-2">
            <i class="bi bi-pencil-square"></i> Editar
        </a>
        <a href="{{ url_for('investigacoes') }}" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Voltar
        </a>
    </div>
</div>

<!-- Informações Principais -->
<div class="row">
    <div class="col-md-8">
        <div class="card mb-3">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> Informações Gerais</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Processo GDOC:</strong><br>
                        {{ investigacao.processo_gdoc or '-' }}
                    </div>
                    <div class="col-md-6">
                        <strong>Protocolo Origem:</strong><br>
                        {{ investigacao.protocolo_origem or '-' }}
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Origem:</strong><br>
                        {{ investigacao.origem or '-' }} / {{ investigacao.canal or '-' }}
                    </div>
                    <div class="col-md-6">
                        <strong>Unidade de Origem:</strong><br>
                        {{ investigacao.unidade_origem or '-' }}
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Classificação:</strong><br>
                        <span class="badge bg-secondary">{{ investigacao.classificacao or '-' }}</span>
                    </div>
                    <div class="col-md-6">
                        <strong>Assunto:</strong><br>
                        <span class="badge bg-info">{{ investigacao.assunto or '-' }}</span>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-12">
                        <strong>Denunciante(s):</strong><br>
                        {{ investigacao.denunciante or '-' }}
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Denunciado:</strong><br>
                        {{ investigacao.nome_denunciado or '-' }}<br>
                        <small class="text-muted">Matrícula: {{ investigacao.matricula_denunciado or '-' }}</small>
                    </div>
                    <div class="col-md-6">
                        <strong>Setor / Diretoria:</strong><br>
                        {{ investigacao.setor or '-' }} / {{ investigacao.diretoria or '-' }}<br>
                        <small class="text-muted">Vínculo: {{ investigacao.vinculo or '-' }}</small>
                    </div>
                </div>

                <div class="row">
                    <div class="col-12">
                        <strong>Objeto / Especificação:</strong><br>
                        <p class="mt-2">{{ investigacao.objeto_especificacao or '-' }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Diligências -->
        <div class="card mb-3">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="bi bi-list-check"></i> Diligências</h5>
            </div>
            <div class="card-body">
                {% if investigacao.diligencias %}
                    <p style="white-space: pre-line;">{{ investigacao.diligencias }}</p>
                {% else %}
                    <p class="text-muted">Nenhuma diligência registrada.</p>
                {% endif %}

                <hr>

                <!-- Formulário para adicionar nova diligência -->
                <form method="POST" action="{{ url_for('adicionar_diligencia', id=investigacao.id) }}">
                    <div class="mb-3">
                        <label class="form-label"><strong>Adicionar Nova Diligência:</strong></label>
                        <textarea class="form-control" name="descricao" rows="4" placeholder="Descreva a diligência realizada..." required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-plus-circle"></i> Adicionar Diligência
                    </button>
                </form>
            </div>
        </div>

        <!-- Histórico -->
        <div class="card mb-3">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0"><i class="bi bi-clock-history"></i> Histórico</h5>
            </div>
            <div class="card-body">
                {% if historico %}
                    <div class="timeline">
                        {% for item in historico %}
                        <div class="mb-3 pb-3 border-bottom">
                            <div class="d-flex justify-content-between">
                                <strong>
                                    {% if item.tipo == 'criacao' %}
                                        <i class="bi bi-plus-circle text-success"></i>
                                    {% elif item.tipo == 'edicao' %}
                                        <i class="bi bi-pencil text-warning"></i>
                                    {% elif item.tipo == 'diligencia' %}
                                        <i class="bi bi-clipboard-check text-info"></i>
                                    {% else %}
                                        <i class="bi bi-info-circle text-secondary"></i>
                                    {% endif %}
                                    {{ item.usuario or 'Sistema' }}
                                </strong>
                                <small class="text-muted">
                                    {% if item.data %}
                                        {{ item.data.strftime('%d/%m/%Y %H:%M') }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </small>
                            </div>
                            <p class="mb-0 mt-2" style="white-space: pre-line;">{{ item.descricao }}</p>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted">Nenhum histórico registrado.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Sidebar Direita -->
    <div class="col-md-4">
        <!-- Status -->
        <div class="card mb-3">
            <div class="card-header bg-warning">
                <h5 class="mb-0"><i class="bi bi-flag"></i> Status</h5>
            </div>
            <div class="card-body text-center">
                {% if investigacao.status == 'Em Andamento' %}
                    {% if investigacao.esta_atrasado %}
                        <h3><span class="badge bg-danger">ATRASADO</span></h3>
                    {% else %}
                        <h3><span class="badge bg-warning text-dark">{{ investigacao.status }}</span></h3>
                    {% endif %}
                {% elif investigacao.status == 'Concluída' %}
                    <h3><span class="badge bg-success">{{ investigacao.status }}</span></h3>
                {% else %}
                    <h3><span class="badge bg-secondary">{{ investigacao.status or 'Indefinido' }}</span></h3>
                {% endif %}
            </div>
        </div>

        <!-- Prazos -->
        <div class="card mb-3">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="bi bi-calendar"></i> Prazos</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <strong>Entrada PRFI:</strong><br>
                    {% if investigacao.entrada_prfi %}
                        {{ investigacao.entrada_prfi.strftime('%d/%m/%Y') }}
                    {% else %}
                        -
                    {% endif %}
                </div>

                <div class="mb-3">
                    <strong>Previsão Conclusão:</strong><br>
                    {% if investigacao.previsao_conclusao %}
                        {{ investigacao.previsao_conclusao.strftime('%d/%m/%Y') }}
                    {% else %}
                        -
                    {% endif %}
                </div>

                {% if investigacao.dias_restantes is not none %}
                <div class="mb-0">
                    <strong>Dias Restantes:</strong><br>
                    <h2 class="{% if investigacao.dias_restantes < 0 %}text-danger{% elif investigacao.dias_restantes <= 15 %}text-warning{% else %}text-success{% endif %}">
                        {{ investigacao.dias_restantes }}
                    </h2>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Informações Adicionais -->
        <div class="card">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="bi bi-gear"></i> Detalhes</h5>
            </div>
            <div class="card-body">
                <div class="mb-2">
                    <strong>Responsável:</strong><br>
                    {{ investigacao.responsavel or '-' }}
                </div>

                <div class="mb-2">
                    <strong>Complexidade:</strong><br>
                    {% if investigacao.complexidade == 'Baixa' %}
                        <span class="badge bg-success">{{ investigacao.complexidade }}</span>
                    {% elif investigacao.complexidade == 'Média' %}
                        <span class="badge bg-warning text-dark">{{ investigacao.complexidade }}</span>
                    {% elif investigacao.complexidade == 'Alta' %}
                        <span class="badge bg-danger">{{ investigacao.complexidade }}</span>
                    {% else %}
                        <span class="badge bg-secondary">-</span>
                    {% endif %}
                </div>

                <div class="mb-2">
                    <strong>Ano:</strong><br>
                    {{ investigacao.ano or '-' }}
                </div>

                {% if investigacao.resultado_final %}
                <div class="mb-0">
                    <strong>Resultado:</strong><br>
                    <span class="badge bg-success">{{ investigacao.resultado_final }}</span>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% endblock %}
