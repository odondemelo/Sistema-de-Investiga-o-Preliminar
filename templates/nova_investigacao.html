{% extends "base.html" %}

{% block title %}Nova Investigação - Sistema PIP{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="bi bi-plus-circle"></i> Nova Investigação
    </h1>
</div>

<form method="POST" action="{{ url_for('nova_investigacao') }}">
    <!-- ==================== INFORMAÇÕES BÁSICAS ==================== -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-info-circle"></i> Informações Básicas</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <!-- Responsável (AUTOMÁTICO - HIDDEN) -->
                <input type="hidden" name="responsavel" value="{{ session.get('nome') }}">

                <!-- Origem -->
                <div class="col-md-6 mb-3">
                    <label class="form-label"><strong>Origem:</strong> <span class="text-danger">*</span></label>
                    <select class="form-select" name="origem" required>
                        <option value="">Selecione...</option>
                        <option value="Interno">Interno</option>
                        <option value="Externo">Externo</option>
                    </select>
                </div>

                <!-- Canal -->
                <div class="col-md-6 mb-3">
                    <label class="form-label"><strong>Canal:</strong> <span class="text-danger">*</span></label>
                    <select class="form-select" name="canal" required>
                        <option value="">Selecione...</option>
                        <option value="CGDF">CGDF</option>
                        <option value="TCDF">TCDF</option>
                        <option value="GDOC">GDOC</option>
                        <option value="E-mail">E-mail</option>
                        <option value="Ouvidoria">Ouvidoria</option>
                        <option value="PRF">PRF</option>
                        <option value="Outros">Outros</option>
                    </select>
                </div>

                <!-- Protocolo Origem -->
                <div class="col-md-6 mb-3">
                    <label class="form-label"><strong>Protocolo Origem:</strong></label>
                    <input type="text" class="form-control" name="protocolo_origem" placeholder="Digite o protocolo de origem">
                </div>

                <!-- Admitida/Inadmitida -->
                <div class="col-md-6 mb-3">
                    <label class="form-label"><strong>Admitida/Inadmitida:</strong></label>
                    <select class="form-select" name="admitida_ou_inadmitida">
                        <option value="">Selecione...</option>
                        <option value="Admitida">Admitida</option>
                        <option value="Inadmitida">Inadmitida</option>
                    </select>
                </div>

                <!-- Unidade de Origem -->
                <div class="col-md-6 mb-3">
                    <label class="form-label"><strong>Unidade de Origem:</strong></label>
                    <input type="text" class="form-control" name="unidade_origem" placeholder="Digite a unidade de origem">
                </div>

                <!-- Classificação -->
                <div class="col-md-6 mb-3">
                    <label class="form-label"><strong>Classificação:</strong> <span class="text-danger">*</span></label>
                    <select class="form-select" name="classificacao" id="classificacao" required>
                        <option value="">Selecione...</option>
                        <option value="Transgressão Disciplinar">Transgressão Disciplinar</option>
                        <option value="Licitações e Contratos">Licitações e Contratos</option>
                        <option value="Dano ao Erário">Dano ao Erário</option>
                        <option value="Infração Ambiental">Infração Ambiental</option>
                        <option value="Práticas Operacionais e Comerciais">Práticas Operacionais e Comerciais</option>
                    </select>
                </div>

                <!-- Assunto (DINÂMICO) -->
                <div class="col-md-6 mb-3">
                    <label class="form-label"><strong>Assunto:</strong> <span class="text-danger">*</span></label>
                    <select class="form-select" name="assunto" id="assunto" required>
                        <option value="">Selecione a classificação primeiro...</option>
                    </select>
                </div>

                <!-- Processo GDOC -->
                <div class="col-md-6 mb-3">
                    <label class="form-label"><strong>Processo GDOC:</strong></label>
                    <input type="text" class="form-control" name="processo_gdoc" placeholder="Ex: PROC-001/2025">
                </div>

                <!-- Ano -->
                <div class="col-md-6 mb-3">
                    <label class="form-label"><strong>Ano:</strong></label>
                    <input type="number" class="form-control" name="ano" value="{{ datetime.now().year }}" min="2020" max="2030">
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== ENVOLVIDOS ==================== -->
    <div class="card mb-4">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0"><i class="bi bi-people"></i> Envolvidos</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <!-- Denunciante -->
                <div class="col-12 mb-3">
                    <label class="form-label"><strong>Denunciante(s):</strong></label>
                    <textarea class="form-control" name="denunciante" rows="2" placeholder="Nome(s) do(s) denunciante(s)"></textarea>
                </div>

                <!-- Nome Denunciado -->
                <div class="col-md-6 mb-3">
                    <label class="form-label"><strong>Nome Denunciado:</strong></label>
                    <input type="text" class="form-control" name="nome_denunciado" placeholder="Nome do denunciado">
                </div>

                <!-- Matrícula Denunciado -->
                <div class="col-md-6 mb-3">
                    <label class="form-label"><strong>Matrícula Denunciado:</strong></label>
                    <input type="text" class="form-control" name="matricula_denunciado" placeholder="Matrícula do denunciado">
                </div>

                <!-- Setor -->
                <div class="col-md-4 mb-3">
                    <label class="form-label"><strong>Setor:</strong></label>
                    <input type="text" class="form-control" name="setor" placeholder="Setor do denunciado">
                </div>

                <!-- Diretoria -->
                <div class="col-md-4 mb-3">
                    <label class="form-label"><strong>Diretoria:</strong></label>
                    <select class="form-select" name="diretoria">
                        <option value="">Selecione...</option>
                        <option value="Diretoria Financeira e Comercial">Diretoria Financeira e Comercial</option>
                        <option value="Diretoria de Suporte ao Negócio">Diretoria de Suporte ao Negócio</option>
                        <option value="Diretoria de Regulação">Diretoria de Regulação</option>
                        <option value="Diretoria Jurídica">Diretoria Jurídica</option>
                        <option value="Diretoria de Operação e Manutenção">Diretoria de Operação e Manutenção</option>
                        <option value="Presidência">Presidência</option>
                    </select>
                </div>

                <!-- ✅ NOVO CAMPO: VÍNCULO -->
                <div class="col-md-4 mb-3">
                    <label class="form-label"><strong>Vínculo:</strong></label>
                    <select class="form-select" name="vinculo">
                        <option value="">Selecione...</option>
                        <option value="Efetivo">Efetivo</option>
                        <option value="Comissionado">Comissionado</option>
                        <option value="Terceirizado">Terceirizado</option>
                        <option value="Estagiário">Estagiário</option>
                        <option value="Jovem Aprendiz">Jovem Aprendiz</option>
                        <option value="Outros">Outros</option>
                    </select>
                </div>

            </div>
        </div>
    </div>

    <!-- ==================== OBJETO E DILIGÊNCIAS ==================== -->
    <div class="card mb-4">
        <div class="card-header bg-secondary text-white">
            <h5 class="mb-0"><i class="bi bi-file-text"></i> Objeto e Diligências</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <!-- Objeto/Especificação -->
                <div class="col-12 mb-3">
                    <label class="form-label"><strong>Objeto / Especificação:</strong></label>
                    <textarea class="form-control" name="objeto_especificacao" rows="4" placeholder="Descreva o objeto da investigação..."></textarea>
                </div>

                <!-- Diligências -->
                <div class="col-12 mb-3">
                    <label class="form-label"><strong>Diligências:</strong></label>
                    <textarea class="form-control" name="diligencias" rows="4" placeholder="Descreva as diligências realizadas..."></textarea>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== PRAZOS E STATUS ==================== -->
    <div class="card mb-4">
        <div class="card-header bg-warning">
            <h5 class="mb-0"><i class="bi bi-calendar-check"></i> Prazos e Status</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <!-- Complexidade -->
                <div class="col-md-4 mb-3">
                    <label class="form-label"><strong>Complexidade:</strong></label>
                    <select class="form-select" name="complexidade">
                        <option value="">Selecione...</option>
                        <option value="Baixa">Baixa</option>
                        <option value="Média">Média</option>
                        <option value="Alta">Alta</option>
                    </select>
                </div>

                <!-- Entrada PRFI -->
                <div class="col-md-4 mb-3">
                    <label class="form-label"><strong>Entrada PRFI:</strong></label>
                    <input type="date" class="form-control" name="entrada_prfi" id="entrada_prfi">
                </div>

                <!-- Previsão Conclusão (AUTOMÁTICO) -->
                <div class="col-md-4 mb-3">
                    <label class="form-label"><strong>Previsão Conclusão:</strong></label>
                    <input type="date" class="form-control" name="previsao_conclusao" id="previsao_conclusao" readonly>
                    <small class="text-muted">Calculado automaticamente (120 dias após entrada PRFI)</small>
                </div>

                <!-- Status -->
                <div class="col-md-6 mb-3">
                    <label class="form-label"><strong>Status:</strong></label>
                    <select class="form-select" name="status">
                        <option value="Em Fila">Em Fila</option>
                        <option value="Em Andamento" selected>Em Andamento</option>
                        <option value="Concluída">Concluída</option>
                    </select>
                </div>

                <!-- Resultado Final -->
                <div class="col-md-6 mb-3">
                    <label class="form-label"><strong>Resultado Final:</strong></label>
                    <select class="form-select" name="resultado_final">
                        <option value="">Selecione...</option>
                        <option value="Arquivado">Arquivado</option>
                        <option value="PAD">PAD</option>
                        <option value="TAC">TAC</option>
                        <option value="TCE">TCE</option>
                        <option value="CECC">CECC</option>
                        <option value="CCMC">CCMC</option>
                        <option value="TCR">TCR</option>
                    </select>
                </div>

                <!-- Justificativa -->
                <div class="col-12 mb-3">
                    <label class="form-label"><strong>Justificativa:</strong></label>
                    <textarea class="form-control" name="justificativa" rows="3" placeholder="Justificativa (se necessário)"></textarea>
                </div>
            </div>
        </div>
    </div>

    <!-- Botões -->
    <div class="d-flex justify-content-between mb-5">
        <a href="{{ url_for('investigacoes') }}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Cancelar
        </a>
        <button type="submit" class="btn btn-success btn-lg">
            <i class="bi bi-check-circle"></i> Cadastrar Investigação
        </button>
    </div>
</form>

<!-- ==================== JAVASCRIPT PARA ASSUNTO DINÂMICO E CÁLCULO DE PRAZO ==================== -->
<script>
// Mapeamento de Classificação -> Assuntos
const assuntosPorClassificacao = {
    "Transgressão Disciplinar": [
        "Falta Injustificada",
        "Tratamento Inadequado de Ponto",
        "Fraude no Ponto Eletrônico",
        "Insubordinação",
        "Desídia",
        "Assédio Moral",
        "Assédio Sexual",
        "Favorecimento pessoal",
        "Favorecimento terceiros",
        "Corrupção",
        "Enriquecimento Ilícito",
        "Condução de Veículos",
        "Nepotismo",
        "Vazamento de Informações",
        "Infração ética",
        "Falta de Urbanidade",
        "Abuso de Autoridade",
        "Falta de Zelo",
        "Conduta Discriminatória",
        "Conflito de Interesses",
        "Conduta Irregular",
        "Desvio de Função",
        "Null"
    ],
    "Dano ao Erário": [
        "Dano ao Patrimônio",
        "Desvio de Material",
        "Pagamento Indevido",
        "Extravio bem Patrimonial",
        "Mau uso de Bens",
        "Furto de bem Patrimonial",
        "Multas",
        "Enriquecimento Ilícito",
        "Null"
    ],
    "Licitações e Contratos": [
        "Fraude em Licitação",
        "Contratação Emergencial",
        "Fiscalização de Contrato",
        "Favorecimento em Licitação",
        "Irregularidades em Licitação",
        "Reconhecimento de Dívida",
        "Null"
    ],
    "Infração Ambiental": [
        "Dano ambiental"
    ],
    "Práticas Operacionais e Comerciais": [
        "Execução inadequada de Serviço",
        "Má conduta no Atendimento",
        "Negligência Operacional",
        "Null"
    ]
};

// Atualizar assuntos quando classificação mudar
document.getElementById('classificacao').addEventListener('change', function() {
    const classificacao = this.value;
    const assuntoSelect = document.getElementById('assunto');

    // Limpar opções anteriores
    assuntoSelect.innerHTML = '<option value="">Selecione...</option>';

    // Adicionar novas opções
    if (classificacao && assuntosPorClassificacao[classificacao]) {
        assuntosPorClassificacao[classificacao].forEach(function(assunto) {
            const option = document.createElement('option');
            option.value = assunto;
            option.textContent = assunto;
            assuntoSelect.appendChild(option);
        });
    }
});

// Calcular previsão de conclusão (120 dias após entrada PRFI)
document.getElementById('entrada_prfi').addEventListener('change', function() {
    const entradaData = new Date(this.value);

    if (!isNaN(entradaData.getTime())) {
        // Adicionar 120 dias
        entradaData.setDate(entradaData.getDate() + 120);

        // Formatar para YYYY-MM-DD
        const ano = entradaData.getFullYear();
        const mes = String(entradaData.getMonth() + 1).padStart(2, '0');
        const dia = String(entradaData.getDate()).padStart(2, '0');

        document.getElementById('previsao_conclusao').value = `${ano}-${mes}-${dia}`;
    }
});
</script>

{% endblock %}
